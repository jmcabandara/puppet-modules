<% if (@htpasswd || @authz_require) -%>
    <%# Access Restrictions -%>
    <Location />

        <%- if @htpasswd -%>
            AuthType Basic
            AuthName "<%= @servername %>"
            AuthBasicProvider <%= @authbasicprovider %>

            AuthUserFile /etc/apache2/htpasswd/<%= @servername %>

            <%- if @authldapurl -%>
                AuthLDAPURL <%= @authldapurl %>
                <%- if @authldapbinddn -%>
                    AuthLDAPBindDN <%= @authldapbinddn %>
                <%- end -%>
                <%- if @authldapbindpassword -%>
                    AuthLDAPBindPassword <%= @authldapbindpassword %>
                <%- end -%>
                <%- if @authldapbindauthoritative -%>
                    AuthLDAPBindAuthoritative <%= @authldapbindauthoritative %>
                <%- end -%>
            <%- end -%>

            Require valid-user
        <%- end -%>

        <%- if @authz_require -%>
            Require <%= @authz_require %>
        <%- end -%>

    </Location>
<%- end -%>

<%-# Custom Rewrite Rules -%>
<%- if @rewrite -%>
    RewriteEngine On
    <%= @rewrite %>
<%- end -%>

<%- if @serveralias && @normalize -%>
    # Normalize URLs to <%= @servername %>
    RewriteEngine On
    RewriteCond %{HTTP_HOST} !^<%= @servername.gsub(/\./, "\\.") %>$ [NC]
    RewriteRule ^ %{REQUEST_SCHEME}://<%= @servername %>%{REQUEST_URI} [L,R=301]
<%- end -%>

<%= scope.function_template([File.dirname(__FILE__) + "/" + "virtualhost.erb"]) %>
