## THIS FILE IS MANAGED BY PUPPET
## modules<%= template_source.gsub(Regexp.new("^#{Puppet::Node::Environment.current[:modulepath].gsub(':','|')}"),"") %>

# Drop all IPv4 packet fragments
domain ip table filter chain INPUT fragment DROP;

# Default rules
domain (ip ip6) {
    table filter {
        # Default Policy
        chain (INPUT OUTPUT FORWARD) policy DROP;

        # loopback traffic
        chain INPUT interface lo ACCEPT;
        chain OUTPUT outerface lo ACCEPT;
    }
}

# Local rules that are exempt from OSSEC filtering
include 'ossec.exempt.d/';

domain (ip ip6) {
    # OSSEC blocks
    include 'ossec.ferm';

    table filter {
        chain (INPUT OUTPUT FORWARD) {
            # ICMP is very handy and necessary
            proto icmp ACCEPT;
            # allow all related and established traffic (connection tracking)
            mod conntrack ctstate (RELATED ESTABLISHED) ACCEPT;
        }
    }
}

# Local rules
include 'ferm.d/';

# Default actions
domain (ip ip6) {
    table filter {
        chain INPUT { <%= @input %>; }
        chain OUTPUT { <%= @output %>; }
        chain FORWARD { <%= @forward %>; }
        chain OSSEC {
            LOG log-prefix "Blocked by OSSEC: ";
            DROP;
        }
    } 
}
