## THIS FILE IS MANAGED BY PUPPET
## https://github.com/Lullabot/puppet
## modules<%= template_source.gsub(Regexp.new("^#{Puppet::Node::Environment.current[:modulepath].gsub(':','|')}"),"") %>

<VirtualHost *:<%= @http_port %>>
    ServerName <%= @servername %>
<% if @serveralias -%>
    ServerAlias <%= @serveralias %>
<% end -%>

    SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on

    ErrorLog ${APACHE_LOG_DIR}/<%= @servername %>_error.log
    CustomLog ${APACHE_LOG_DIR}/<%= @servername %>_access.log vhost_combined

<% if @proxy && @awstats -%>
    # Do not proxy awstats
    ProxyPass /awstats.pl !
    ProxyPass /awstats-icon !
    ProxyPass /awstatsclasses !
<% end -%>

<% if @proxy -%>
    # Proxy to Backend
    SSLProxyEngine On
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyAddHeaders <%= @proxyaddheaders %>
    ProxyPass /socket.io/1/websocket/ <%= @proxy.gsub(/^https?/,'ws').gsub(/\/$/,'') %>/socket.io/1/websocket/ retry=0
    ProxyPass / <%= @proxy.gsub(/\/$/, '') %>/
    ProxyPassReverse / <%= @proxy.gsub(/\/$/, '') %>/
<% else -%>
    DocumentRoot <%= @docroot.gsub(/\/$/, '') %>
    <Directory <%= @docroot.gsub(/\/$/, '') %>>
        Options <%= @options %>
        AllowOverride <%= @allowoverride %>
        DirectoryIndex <%= @directoryindex %>
        Require all granted
    </Directory>
<% end -%>

<% if @authz_require -%>
    <Location />
        Require <%= @authz_require %>
        # Restricted access should not be cached
        Header set Cache-Control "private, no-cache, no-store, max-age=0, must-revalidate, proxy-revalidate"
        Header set Pragma "no-cache"
    </Location>
<% end -%>

<% if @htpasswd -%>
    <Location />
        AuthType Basic
        AuthName "<%= @servername %>"
        AuthBasicProvider file ldap

        AuthUserFile /etc/apache2/htpasswd/<%= @servername %>

        AuthLDAPURL ldap://ldap.lullabot.com/ou=people,dc=lullabot,dc=com?uid STARTTLS
        AuthLDAPBindDN cn=apache,ou=DSA,dc=lullabot,dc=com
        AuthLDAPBindPassword aiNohzooneedeatheegifieg8le7uche
        AuthLDAPBindAuthoritative off

        Require valid-user
    </Location>
<% end -%>

<% if @allowencodedslashes -%>
    AllowEncodedSlashes <%= @allowencodedslashes %>
<% end -%>

<% if @php_value || @php_flag -%>
    # PHP Settings
<% if @php_value -%>
<% @php_value.each do |value| -%>
    php_value <%= value[0] %> <%= value[1] %>
<% end -%>
<% end -%>
<% if @php_flag -%>
<% @php_flag.each do |flag| -%>
    php_flag <%= flag[0] %> <%= flag[1] %>
<% end -%>
<% end -%>
<% end -%>

    RewriteEngine On

<% if @serveralias && @normalize -%>
    # Normalize URLs to <%= @servername %>
    RewriteCond %{HTTP_HOST} !^<%= @servername.gsub(/\./, "\\.") %>$ [NC]
    RewriteRule ^ %{REQUEST_SCHEME}://<%= @servername %>%{REQUEST_URI} [L,R=301]
<% end -%>

<% if @https == 'force' -%>
    # Force HTTPS
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
<% end -%>

<% if @awstats -%>
    # Awstats for this vhost
    RewriteCond %{QUERY_STRING} ^$
    RewriteRule ^/awstats(\.pl)?$ https://<%= @fqdn %>/awstats.pl?config=<%= @servername %> [L,R=301]
<% end -%>
</VirtualHost>

<% if @https -%>
<VirtualHost *:<%= @https_port %>>
    ServerName <%= @servername %>
<% if @serveralias -%>
    ServerAlias <%= @serveralias %>
<% end -%>

    ErrorLog ${APACHE_LOG_DIR}/<%= @servername %>_error.log
    CustomLog ${APACHE_LOG_DIR}/<%= @servername %>_access.log vhost_combined

    SSLEngine On
    SSLCertificateFile <%= @sslcertificatefile %>
    SSLCertificateKeyFile <%= @sslcertificatekeyfile %>
<% if @sslcertificatechainfile -%>
    SSLCertificateChainFile <%= @sslcertificatechainfile %>
<% end -%>

    ProxyRequests Off
    ProxyPreserveHost On
<% if @proxy -%>
    ProxyPass /socket.io/1/websocket/ <%= @proxy.gsub(/^https?/,'ws').gsub(/\/$/,'') %>/socket.io/1/websocket/ retry=0
<% end -%>
    ProxyPass / http://localhost/ retry=0 nocanon
    ProxyPassReverse / http://localhost/

<% if @allowencodedslashes -%>
    AllowEncodedSlashes <%= @allowencodedslashes %>
<% end -%>

    RequestHeader set X-Forwarded-Proto "https"
    Header edit Location ^http: https:
<% if @hsts -%>
    Header add Strict-Transport-Security "max-age=<%= @hsts %>"
<% end -%>
</VirtualHost>
<% end -%>
